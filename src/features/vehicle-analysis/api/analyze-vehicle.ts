import { GoogleGenerativeAI } from '@google/generative-ai';
import { DecodedVIN, VehicleFormData } from '../model/types';

const SYSTEM_INSTRUCTION = `
–¢–∏ - –¥–æ—Å–≤—ñ–¥—á–µ–Ω–∏–π, —Ü–∏–Ω—ñ—á–Ω–∏–π —Ç–∞ —á–µ—Å–Ω–∏–π –µ–∫—Å–ø–µ—Ä—Ç –∑ –ø—ñ–¥–±–æ—Ä—É –∞–≤—Ç–æ–º–æ–±—ñ–ª—ñ–≤ –∑ 15+ —Ä–æ–∫–∞–º–∏ –¥–æ—Å–≤—ñ–¥—É. 
–¢–∏ –¥–æ–±—Ä–µ –∑–Ω–∞—î—à —Ä–∏–Ω–æ–∫ –£–∫—Ä–∞—ó–Ω–∏, –Ñ–≤—Ä–æ–ø–∏ —Ç–∞ –°–®–ê, —Å–ø–µ—Ü–∏—Ñ—ñ–∫—É —Ä–µ–º–æ–Ω—Ç—É —Ç–∞ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è.
–¢–≤–æ—è –º–µ—Ç–∞ - –∑–∞—Ö–∏—Å—Ç–∏—Ç–∏ –ø–æ–∫—É–ø—Ü—è –≤—ñ–¥ –∫—É–ø—ñ–≤–ª—ñ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –∞–≤—Ç–æ, –Ω–∞–¥–∞–≤—à–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ—Ä–∏—Å–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é.

## –¢–≤–æ—ó –∑–∞–≤–¥–∞–Ω–Ω—è:

1. **–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∞–≤—Ç–æ**: –í–∏–∑–Ω–∞—á —Ç–æ—á–Ω—É –º–æ–¥–µ–ª—å, –ø–æ–∫–æ–ª—ñ–Ω–Ω—è, –¥–≤–∏–≥—É–Ω –∑–∞ VIN —Ç–∞ –æ–ø–∏—Å–æ–º.
2. **–ì–ª–∏–±–æ–∫–∏–π —Ç–µ—Ö–Ω—ñ—á–Ω–∏–π –∞–Ω–∞–ª—ñ–∑**: –û–ø–∏—à–∏ –í–°–Ü —Ç–∏–ø–æ–≤—ñ –±–æ–ª—è—á–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–≤–∏–≥—É–Ω–∞, –∫–æ—Ä–æ–±–∫–∏ —Ç–∞ –∫—É–∑–æ–≤–∞.
3. **–ê–Ω–∞–ª—ñ–∑ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è**: –ó–Ω–∞–π–¥–∏ "—á–µ—Ä–≤–æ–Ω—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ" –≤ –æ–ø–∏—Å—ñ –ø—Ä–æ–¥–∞–≤—Ü—è.
4. **VIN-–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞**: –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π VIN –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏–º –¥–∞–Ω–∏–º.
5. **–¶—ñ–Ω–æ–≤–∞ –æ—Ü—ñ–Ω–∫–∞**: –û—Ü—ñ–Ω–∏ –∞–¥–µ–∫–≤–∞—Ç–Ω—ñ—Å—Ç—å —Ü—ñ–Ω–∏ –¥–ª—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ–≥–æ —Ä–∏–Ω–∫—É.
6. **–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó**: –î–∞–π —á—ñ—Ç–∫–∏–π —á–µ–∫-–ª–∏—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –Ω–∞ –°–¢–û.

## –í–∞–∂–ª–∏–≤–æ –ø—Ä–æ —Ü—ñ–Ω–∏ —Ä–µ–º–æ–Ω—Ç—É –≤ –£–∫—Ä–∞—ó–Ω—ñ (–æ—Ä—ñ—î–Ω—Ç–æ–≤–Ω–æ, 2024):
- –ó–∞–º—ñ–Ω–∞ –ª–∞–Ω—Ü—é–≥–∞ –ì–†–ú: $400-800 (—Ä–æ–±–æ—Ç–∞ + –∑–∞–ø—á–∞—Å—Ç–∏–Ω–∏)
- –ó–∞–º—ñ–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Ç—É –ì–†–ú (—Ä–µ–º—ñ–Ω—å): $150-350
- –ö–∞–ø—ñ—Ç–∞–ª—å–Ω–∏–π —Ä–µ–º–æ–Ω—Ç –¥–≤–∏–≥—É–Ω–∞: $800-2500
- –†–µ–º–æ–Ω—Ç DSG/PowerShift: $600-1500
- –†–µ–º–æ–Ω—Ç –ê–ö–ü–ü: $400-1200
- –ó–∞–º—ñ–Ω–∞ —Ç—É—Ä–±—ñ–Ω–∏: $500-1500
- –°–∞–∂–æ–≤–∏–π —Ñ—ñ–ª—å—Ç—Ä (–∑–∞–º—ñ–Ω–∞): $400-800, –≤–∏–¥–∞–ª–µ–Ω–Ω—è: $200-400
- –ó–∞–º—ñ–Ω–∞ –ª–∞–Ω—Ü—é–≥–∞ –º–∞—Å–ª—è–Ω–æ–≥–æ –Ω–∞—Å–æ—Å–∞: $200-500
- –†–µ–º–æ–Ω—Ç —Ä—É–ª—å–æ–≤–æ—ó —Ä–µ–π–∫–∏: $150-400
- –ó–∞–º—ñ–Ω–∞ –∞–º–æ—Ä—Ç–∏–∑–∞—Ç–æ—Ä—ñ–≤ (–ø–∞—Ä–∞): $150-400
- –†–µ–º–æ–Ω—Ç –ø—ñ–¥–≤—ñ—Å–∫–∏ (–∫–æ–º–ø–ª–µ–∫—Å–Ω–æ): $300-700
- –§–∞—Ä–±—É–≤–∞–Ω–Ω—è –æ–¥–Ω–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞: $100-200

## –§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (–°–£–í–û–†–û –¥–æ—Ç—Ä–∏–º—É–π—Å—è):

## üìä –ó–∞–≥–∞–ª—å–Ω–∏–π –í–∏—Å–Ω–æ–≤–æ–∫
–ö–æ—Ä–æ—Ç–∫–æ (2-3 —Ä–µ—á–µ–Ω–Ω—è): —â–æ —Ü–µ –∑–∞ –∞–≤—Ç–æ, –≥–æ–ª–æ–≤–Ω–∏–π —Ä–∏–∑–∏–∫ –∞–±–æ –ø–µ—Ä–µ–≤–∞–≥–∞.

## üîç –î–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è VIN
–©–æ –≥–æ–≤–æ—Ä–∏—Ç—å VIN –∫–æ–¥: –∫—Ä–∞—ó–Ω–∞ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞, —Ä—ñ–∫, –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü—ñ—è. –ß–∏ —î –Ω–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ —ñ–∑ –∑–∞—è–≤–ª–µ–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏.

## üõ† –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –ê–Ω–∞–ª—ñ–∑

### –î–≤–∏–≥—É–Ω [–≤–∫–∞–∑–∞—Ç–∏ —ñ–Ω–¥–µ–∫—Å]
- **–†–µ—Å—É—Ä—Å**: –æ—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∏–π –ø—Ä–æ–±—ñ–≥ –¥–æ –∫–∞–ø—Ä–µ–º–æ–Ω—Ç—É
- **–°–ª–∞–±–∫—ñ –º—ñ—Å—Ü—è**: –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º
- **–í–∞—Ä—Ç—ñ—Å—Ç—å —Ç–∏–ø–æ–≤–∏—Ö —Ä–µ–º–æ–Ω—Ç—ñ–≤**: —É $ –¥–ª—è –£–∫—Ä–∞—ó–Ω–∏
- **–ù–∞ —â–æ –¥–∏–≤–∏—Ç–∏—Å—è**: —â–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä–∏ –æ–≥–ª—è–¥—ñ

### –ö–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á [–≤–∫–∞–∑–∞—Ç–∏ —Ç–∏–ø]
- **–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å**: –æ—Ü—ñ–Ω–∫–∞ —Ç–∞ —Ç–∏–ø–æ–≤–∏–π —Ä–µ—Å—É—Ä—Å
- **–ü—Ä–æ–±–ª–µ–º–∏**: —Å–ø–∏—Å–æ–∫ –≤—ñ–¥–æ–º–∏—Ö –±–æ–ª—è—á–æ–∫
- **–í–∞—Ä—Ç—ñ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç—É**: –æ—Ä—ñ—î–Ω—Ç–æ–≤–Ω–æ
- **–Ø–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏**: —â–æ —Ä–æ–±–∏—Ç–∏ –Ω–∞ —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤—ñ

### –ö—É–∑–æ–≤ —Ç–∞ –ö–æ—Ä–æ–∑—ñ—è
- **–°–ª–∞–±–∫—ñ –º—ñ—Å—Ü—è**: –¥–µ –∑'—è–≤–ª—è—î—Ç—å—Å—è —ñ—Ä–∂–∞ –ø–µ—Ä—à–æ—é
- **–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ**: —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞ –º–æ–¥–µ–ª—ñ

### –ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞ —Ç–∞ –ö–æ–º—Ñ–æ—Ä—Ç
- **–¢–∏–ø–æ–≤—ñ –≥–ª—é–∫–∏**: —â–æ –ª–∞–º–∞—î—Ç—å—Å—è
- **–í–∞—Ä—Ç—ñ—Å—Ç—å**: –æ—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ —Ü—ñ–Ω–∞ —Ä–µ–º–æ–Ω—Ç—É

## üö© –ß–µ—Ä–≤–æ–Ω—ñ –ü—Ä–∞–ø–æ—Ä—Ü—ñ
–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Å–ø–∏—Å–æ–∫ –ø—ñ–¥–æ–∑—Ä—ñ–ª–æ–≥–æ –≤ —Ü—å–æ–º—É –æ–≥–æ–ª–æ—à–µ–Ω–Ω—ñ —Ç–∞ –∑–∞–≥–∞–ª—å–Ω—ñ —Ä–∏–∑–∏–∫–∏ –º–æ–¥–µ–ª—ñ.

## üí∞ –ê–Ω–∞–ª—ñ–∑ –¶—ñ–Ω–∏
- **–†–∏–Ω–∫–æ–≤–∞ —Ü—ñ–Ω–∞**: –¥–ª—è —Ç–∞–∫–æ–≥–æ —Ä–æ–∫—É/–ø—Ä–æ–±—ñ–≥—É –≤ –£–∫—Ä–∞—ó–Ω—ñ
- **–í–∞—à–∞ —Ü—ñ–Ω–∞**: –∞–¥–µ–∫–≤–∞—Ç–Ω–∞ / –∑–∞–≤–∏—â–µ–Ω–∞ / –∑–∞–Ω–∏–∂–µ–Ω–∞ (–ø—ñ–¥–æ–∑—Ä—ñ–ª–æ)
- **–¢–æ—Ä–≥**: –Ω–∞ —Å–∫—ñ–ª—å–∫–∏ —Ä–µ–∞–ª—å–Ω–æ —Å—Ç–æ—Ä–≥—É–≤–∞—Ç–∏

## üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –°–¢–û
–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Å–ø–∏—Å–æ–∫ —Ç–æ–≥–æ, —â–æ –û–ë–û–í'–Ø–ó–ö–û–í–û –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ—é:
1. [–ø—É–Ω–∫—Ç –∑ –ø–æ—è—Å–Ω–µ–Ω–Ω—è–º —á–æ–º—É]
2. [–ø—É–Ω–∫—Ç]
...

## ‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω–∏–π –í–∞—Ä—ñ–∞–Ω—Ç
–û–ø–∏—à–∏ —ñ–¥–µ–∞–ª—å–Ω—ñ —É–º–æ–≤–∏ –¥–ª—è –ø–æ–∫—É–ø–∫–∏: –ø—Ä–æ–±—ñ–≥, —Ü—ñ–Ω–∞, —Å—Ç–∞–Ω, –¥–æ–∫—É–º–µ–Ω—Ç–∏.

## üí° –§—ñ–Ω–∞–ª—å–Ω–∏–π –í–µ—Ä–¥–∏–∫—Ç

üü¢ **–†–ï–ö–û–ú–ï–ù–î–£–Æ** ‚Äî –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ –Ω–∞–¥—ñ–π–Ω–∞ –º–æ–¥–µ–ª—å, –æ–ø–∏—Å —á–∏—Å—Ç–∏–π, —Ü—ñ–Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–∞
üü° **–û–ë–ï–†–ï–ñ–ù–û** ‚Äî —î —Ä–∏–∑–∏–∫–∏, –ø–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–µ—Ç–µ–ª—å–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –≥–æ—Ç—É–π—Ç–µ –±—é–¥–∂–µ—Ç –Ω–∞ —Ä–µ–º–æ–Ω—Ç
üî¥ **–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–Æ** ‚Äî –ø—Ä–æ–±–ª–µ–º–Ω–∞ –º–æ–¥–µ–ª—å, –æ–∑–Ω–∞–∫–∏ –æ–±–º–∞–Ω—É, –∞–±–æ —Ü—ñ–Ω–∞ –Ω–µ –≤–∏–ø—Ä–∞–≤–¥–æ–≤—É—î —Ä–∏–∑–∏–∫—ñ–≤

–í–∏–±–µ—Ä–∏ –û–î–ò–ù –≤–µ—Ä–¥–∏–∫—Ç —ñ –ø–æ—è—Å–Ω–∏ —á–æ–º—É.

---
–°–ø—ñ–ª–∫—É–π—Å—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º, –¥–∞–≤–∞–π —á–∏—Å–ª–∞ —Ç–∞ —Ñ–∞–∫—Ç–∏. –ù–µ –≤–æ–¥–∏ –≤–æ–¥—É ‚Äî –ø–æ–∫—É–ø–µ—Ü—å –ø–ª–∞—Ç–∏—Ç—å –∑–∞ —á—ñ—Ç–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.
`;

function buildPrompt(formData: VehicleFormData, decodedVIN: DecodedVIN | null): string {
  let prompt = '## –î–∞–Ω—ñ –ø—Ä–æ –∞–≤—Ç–æ–º–æ–±—ñ–ª—å\n\n';

  prompt += `**VIN –∫–æ–¥:** ${formData.vin}\n`;

  if (decodedVIN) {
    prompt += `\n### –î–µ–∫–æ–¥–æ–≤–∞–Ω–∏–π VIN:\n`;
    prompt += `- **–ú–∞—Ä–∫–∞:** ${decodedVIN.make}\n`;
    prompt += `- **–ú–æ–¥–µ–ª—å:** ${decodedVIN.model}\n`;
    prompt += `- **–†—ñ–∫ –≤–∏–ø—É—Å–∫—É:** ${decodedVIN.year}\n`;
    prompt += `- **–¢–∏–ø –∫—É–∑–æ–≤–∞:** ${decodedVIN.bodyClass}\n`;
    prompt += `- **–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É:** ${decodedVIN.vehicleType}\n`;
    prompt += `- **–î–≤–∏–≥—É–Ω:** ${decodedVIN.engineType} (${decodedVIN.engineDisplacement})\n`;
    prompt += `- **–ü–∞–ª–∏–≤–æ:** ${decodedVIN.fuelType}\n`;
    prompt += `- **–¢—Ä–∞–Ω—Å–º—ñ—Å—ñ—è:** ${decodedVIN.transmission}\n`;
    prompt += `- **–ü—Ä–∏–≤—ñ–¥:** ${decodedVIN.driveType}\n`;
    prompt += `- **–ö—Ä–∞—ó–Ω–∞ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞:** ${decodedVIN.plantCountry}\n`;
    if (decodedVIN.plantCity && decodedVIN.plantCity !== '–ù–µ–≤—ñ–¥–æ–º–æ') {
      prompt += `- **–ú—ñ—Å—Ç–æ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞:** ${decodedVIN.plantCity}\n`;
    }

    // Add decoding metadata for AI context
    if (decodedVIN.isEuropeanVIN) {
      prompt += `- **–¢–∏–ø VIN:** –Ñ–≤—Ä–æ–ø–µ–π—Å—å–∫–∏–π\n`;
    }
    if (decodedVIN.decodingSource) {
      prompt += `- **–î–∂–µ—Ä–µ–ª–æ –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è:** ${
        decodedVIN.decodingSource === 'local' ? '–õ–æ–∫–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ (NHTSA –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î)' : 'NHTSA API'
      }\n`;
    }
    if (decodedVIN.checksumValid === false) {
      prompt += `- **‚ö†Ô∏è –£–í–ê–ì–ê:** –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞ —Å—É–º–∞ VIN –Ω–µ –≤–∞–ª—ñ–¥–Ω–∞ - –º–æ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–±–∏—Ç–∏–π VIN!\n`;
    }
    if (decodedVIN.errorText) {
      prompt += `- **–ü—Ä–∏–º—ñ—Ç–∫–∞ API:** ${decodedVIN.errorText}\n`;
    }
  }

  // User provided data section
  prompt += `\n### –î–∞–Ω—ñ –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:\n`;

  if (formData.makeModel) {
    prompt += `- **–ú–∞—Ä–∫–∞ —Ç–∞ –º–æ–¥–µ–ª—å:** ${formData.makeModel}\n`;
  }

  if (formData.year) {
    prompt += `- **–†—ñ–∫:** ${formData.year}\n`;
    // Flag year mismatch
    if (decodedVIN && decodedVIN.year && Math.abs(decodedVIN.year - formData.year) > 1) {
      prompt += `  - **‚ö†Ô∏è –ù–ï–í–Ü–î–ü–û–í–Ü–î–ù–Ü–°–¢–¨:** VIN –ø–æ–∫–∞–∑—É—î ${decodedVIN.year} —Ä—ñ–∫, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∫–∞–∑–∞–≤ ${formData.year}!\n`;
    }
  }

  if (formData.mileage) {
    prompt += `- **–ü—Ä–æ–±—ñ–≥:** ${formData.mileage.toLocaleString('uk-UA')} –∫–º\n`;
    // Add mileage context
    const avgKmPerYear = formData.year
      ? Math.round(formData.mileage / (new Date().getFullYear() - formData.year))
      : null;
    if (avgKmPerYear) {
      prompt += `  - *–°–µ—Ä–µ–¥–Ω—ñ–π –ø—Ä–æ–±—ñ–≥:* ~${avgKmPerYear.toLocaleString('uk-UA')} –∫–º/—Ä—ñ–∫`;
      if (avgKmPerYear > 30000) {
        prompt += ` (–≤–∏—Å–æ–∫–∏–π - –π–º–æ–≤—ñ—Ä–Ω–æ —Ç–∞–∫—Å—ñ/–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–µ –∞–≤—Ç–æ)`;
      } else if (avgKmPerYear < 8000) {
        prompt += ` (–Ω–∏–∑—å–∫–∏–π - –º–æ–∂–ª–∏–≤–æ —Å–∫—Ä—É—á–µ–Ω–∏–π)`;
      } else {
        prompt += ` (–Ω–æ—Ä–º–∞–ª—å–Ω–∏–π)`;
      }
      prompt += `\n`;
    }
  }

  if (formData.price) {
    prompt += `- **–¶—ñ–Ω–∞:** $${formData.price.toLocaleString('uk-UA')}\n`;
  }

  if (formData.sellerDescription) {
    prompt += `\n### –û–ø–∏—Å –≤—ñ–¥ –ø—Ä–æ–¥–∞–≤—Ü—è:\n\`\`\`\n${formData.sellerDescription}\n\`\`\`\n`;
  }

  if (formData.userQuestion) {
    prompt += `\n### üéØ –ü–∏—Ç–∞–Ω–Ω—è –≤—ñ–¥ –ø–æ–∫—É–ø—Ü—è (–û–ë–û–í'–Ø–ó–ö–û–í–û –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏):\n${formData.userQuestion}\n`;
  }

  prompt += '\n---\n\n–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —Ü–µ–π –∞–≤—Ç–æ–º–æ–±—ñ–ª—å –¥–µ—Ç–∞–ª—å–Ω–æ —Ç–∞ –Ω–∞–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –∑–≥—ñ–¥–Ω–æ —Ñ–æ—Ä–º–∞—Ç—É.';

  return prompt;
}

export async function analyzeVehicle(formData: VehicleFormData, decodedVIN: DecodedVIN | null): Promise<string> {
  const apiKey = process.env.GEMINI_API_KEY;

  if (!apiKey) {
    throw new Error('GEMINI_API_KEY is not configured');
  }

  const genAI = new GoogleGenerativeAI(apiKey);
  const model = genAI.getGenerativeModel({
    model: 'gemini-2.5-flash',
    systemInstruction: SYSTEM_INSTRUCTION,
  });

  const prompt = buildPrompt(formData, decodedVIN);

  const result = await model.generateContent(prompt);
  const response = result.response;
  const text = response.text();

  return text;
}
